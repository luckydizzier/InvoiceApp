<UserControl x:Class="InvoiceApp.Views.InvoiceItemDataGrid"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="200" d:DesignWidth="400">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    </UserControl.Resources>
    <DataGrid x:Name="InnerGrid"
              ItemsSource="{Binding Items}"
              SelectedItem="{Binding SelectedItem}"
              AutoGenerateColumns="False"
              CanUserAddRows="True"
              RowDetailsVisibilityMode="{Binding IsRowDetailsVisible, Converter={StaticResource BoolToVisibilityConverter}}"
              Margin="0,0,0,4">
        <DataGrid.InputBindings>
            <KeyBinding Key="Enter" Command="{Binding ItemsEnterCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
            <KeyBinding Key="Up" Command="{Binding ItemsUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
            <KeyBinding Key="Down" Command="{Binding ItemsDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
            <KeyBinding Key="Escape" Command="{Binding ItemsEscapeCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
        </DataGrid.InputBindings>
        <DataGrid.Columns>
            <DataGridTemplateColumn Header="TermÃ©k" Width="2*">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Item.Product.Name}" />
                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
                <DataGridTemplateColumn.CellEditingTemplate>
                    <DataTemplate>
                        <ComboBox ItemsSource="{Binding DataContext.Products, RelativeSource={RelativeSource AncestorType=Window}}"
                                  SelectedItem="{Binding Item.Product, UpdateSourceTrigger=PropertyChanged}"
                                  DisplayMemberPath="Name"/>
                    </DataTemplate>
                </DataGridTemplateColumn.CellEditingTemplate>
            </DataGridTemplateColumn>
            <DataGridTextColumn Header="MennyisÃ©g"
                               Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F2}}"
                               Width="Auto"
                               ElementStyle="{StaticResource RightAlignedCellStyle}"/>
            <DataGridTextColumn Header="EgysÃ©g"
                               Binding="{Binding Item.Product.Unit.Code}"
                               Width="Auto"/>
            <DataGridTextColumn Header="Ãr"
                               Binding="{Binding UnitPrice, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F2}}"
                               Width="Auto"
                               ElementStyle="{StaticResource RightAlignedCellStyle}"/>
            <DataGridTemplateColumn Header="ÃFA %" Width="Auto">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Item.TaxRate.Name}" />
                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
                <DataGridTemplateColumn.CellEditingTemplate>
                    <DataTemplate>
                        <ComboBox ItemsSource="{Binding DataContext.TaxRates, RelativeSource={RelativeSource AncestorType=Window}}"
                                  SelectedItem="{Binding TaxRate, UpdateSourceTrigger=PropertyChanged}"
                                  DisplayMemberPath="Name"/>
                    </DataTemplate>
                </DataGridTemplateColumn.CellEditingTemplate>
            </DataGridTemplateColumn>
            <DataGridTextColumn Header="NettÃ³ Ã©rtÃ©k"
                               Binding="{Binding NetAmount, StringFormat={}{0:F2}}"
                               IsReadOnly="True"
                               Width="Auto"
                               ElementStyle="{StaticResource RightAlignedCellStyle}"/>
            <DataGridTextColumn Header="BruttÃ³ Ã©rtÃ©k"
                               Binding="{Binding GrossAmount, StringFormat={}{0:F2}}"
                               IsReadOnly="True"
                               Width="Auto"
                               ElementStyle="{StaticResource RightAlignedCellStyle}"/>
            <DataGridTemplateColumn Header="" Width="Auto">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <Button Content="ðŸ’¾"
                                Command="{Binding DataContext.SaveItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}"
                                Style="{StaticResource IconButtonStyle}"/>
                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>
        </DataGrid.Columns>
        <DataGrid.RowDetailsTemplate>
            <DataTemplate>
                <StackPanel Orientation="Vertical" Margin="5">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="NÃ©v" Width="50" />
                        <TextBox Text="{Binding Item.Product.Name, UpdateSourceTrigger=PropertyChanged}" Width="200" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="NettÃ³" Width="50" />
                        <TextBox Text="{Binding Item.Product.Net, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                        <TextBlock Text="BruttÃ³" Width="50" Margin="10,0,0,0" />
                        <TextBox Text="{Binding Item.Product.Gross, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                    </StackPanel>
                </StackPanel>
            </DataTemplate>
        </DataGrid.RowDetailsTemplate>
    </DataGrid>
</UserControl>
